{"version":3,"file":"kvm.umd.js","sources":["../../../../src/angular/projects/kvm/src/lib/kvm.component.ts","../../../../src/angular/projects/kvm/src/lib/kvm.component.html","../../../../src/angular/projects/kvm/src/lib/kvm.module.ts","../../../../src/angular/projects/kvm/src/public-api.ts","../../../../src/angular/projects/kvm/src/kvm.ts"],"sourcesContent":["import {\r\n  AfterViewInit,\r\n  Component,\r\n  ElementRef,\r\n  EventEmitter,\r\n  Inject,\r\n  Input,\r\n  OnDestroy,\r\n  OnInit,\r\n  Output,\r\n  ViewChild\r\n} from '@angular/core'\r\nimport {\r\n  AMTDesktop,\r\n  AMTKvmDataRedirector,\r\n  ConsoleLogger,\r\n  DataProcessor,\r\n  IDataProcessor,\r\n  ILogger,\r\n  KeyBoardHelper,\r\n  MouseHelper,\r\n  Protocol\r\n} from '@open-amt-cloud-toolkit/ui-toolkit/core'\r\nimport { fromEvent, timer } from 'rxjs'\r\nimport { throttleTime } from 'rxjs/operators'\r\nimport { ActivatedRoute } from '@angular/router'\r\n\r\n@Component({\r\n  selector: 'amt-kvm',\r\n  templateUrl: './kvm.component.html',\r\n  styleUrls: ['./kvm.component.css']\r\n})\r\nexport class KvmComponent implements OnInit, AfterViewInit, OnDestroy {\r\n  @ViewChild('canvas', { static: false }) canvas: ElementRef | undefined\r\n  @ViewChild('device', { static: false }) device: string\r\n  public context!: CanvasRenderingContext2D\r\n\r\n  // //setting a width and height for the canvas\r\n\r\n  @Input() public width = 400\r\n  @Input() public height = 400\r\n  @Output() deviceStatus: EventEmitter<number> = new EventEmitter<number>()\r\n  @Input() deviceConnection: EventEmitter<boolean> = new EventEmitter<boolean>()\r\n  @Input() selectedEncoding: EventEmitter<number> = new EventEmitter<number>()\r\n  token: any\r\n  module: any\r\n  redirector: any\r\n  dataProcessor!: IDataProcessor | null\r\n  mouseHelper!: MouseHelper\r\n  keyboardHelper!: KeyBoardHelper\r\n  logger!: ILogger\r\n  powerState: any = 0\r\n  deviceId: string = ''\r\n  selected: number = 1\r\n  timeInterval!: any\r\n  server: string = ''\r\n  mouseMove: any = null\r\n  mpsServer: boolean\r\n  encodings = [\r\n    { value: 1, viewValue: 'RLE 8' },\r\n    { value: 2, viewValue: 'RLE 16' }\r\n  ]\r\n\r\n  constructor (@Inject('userInput') public params, public activatedRoute: ActivatedRoute) {\r\n    this.token = localStorage.getItem('loggedInUser')\r\n    this.server = `${this.urlConstructor()}/relay`\r\n    this.mpsServer = this.params.mpsServer.includes('/mps')\r\n    if (this.mpsServer) {\r\n      // handles kong route\r\n      this.server = `${this.urlConstructor()}/ws/relay`\r\n    }\r\n  }\r\n\r\n  urlConstructor = (): string => {\r\n    return this.params.mpsServer.replace('http', 'ws')\r\n  }\r\n\r\n  ngOnInit (): void {\r\n    this.activatedRoute.params.subscribe(params => {\r\n      this.deviceId = params.id\r\n    })\r\n    this.logger = new ConsoleLogger(1)\r\n    this.deviceConnection.subscribe((data: boolean) => {\r\n      if (data) {\r\n        this.init()\r\n      } else {\r\n        this.stopKvm()\r\n      }\r\n    })\r\n    this.selectedEncoding.subscribe((data) => {\r\n      this.selected = data\r\n      this.onEncodingChange()\r\n    })\r\n  }\r\n\r\n  ngAfterViewInit (): void {\r\n    this.init()\r\n  }\r\n\r\n  instantiate (): void {\r\n    this.context = this.canvas?.nativeElement.getContext('2d')\r\n    this.redirector = new AMTKvmDataRedirector(\r\n      this.logger,\r\n      Protocol.KVM,\r\n      new FileReader(),\r\n      this.deviceId,\r\n      16994,\r\n      '',\r\n      '',\r\n      0,\r\n      0,\r\n      JSON.parse(this.token).token,\r\n      this.server\r\n    )\r\n    this.module = new AMTDesktop(this.logger as any, this.context)\r\n    this.dataProcessor = new DataProcessor(\r\n      this.logger,\r\n      this.redirector,\r\n      this.module\r\n    )\r\n    this.mouseHelper = new MouseHelper(this.module, this.redirector, 200)\r\n    this.keyboardHelper = new KeyBoardHelper(this.module, this.redirector)\r\n    this.redirector.onProcessData = this.module.processData.bind(this.module)\r\n    this.redirector.onStart = this.module.start.bind(this.module)\r\n    this.redirector.onNewState = this.module.onStateChange.bind(this.module)\r\n    this.redirector.onSendKvmData = this.module.onSendKvmData.bind(this.module)\r\n    this.redirector.onStateChanged = this.onConnectionStateChange.bind(this)\r\n    this.redirector.onError = this.onRedirectorError.bind(this)\r\n    this.module.onSend = this.redirector.send.bind(this.redirector)\r\n    this.module.onProcessData = this.dataProcessor.processData.bind(\r\n      this.dataProcessor\r\n    )\r\n    this.module.bpp = this.selected\r\n    this.mouseMove = fromEvent(this.canvas?.nativeElement, 'mousemove')\r\n    this.mouseMove.pipe(throttleTime(200)).subscribe((event: any) => {\r\n      if (this.mouseHelper != null) {\r\n        this.mouseHelper.mousemove(event)\r\n      }\r\n    })\r\n  }\r\n\r\n  onConnectionStateChange = (redirector: any, state: number): any => {\r\n    this.deviceStatus.emit(state)\r\n  }\r\n\r\n  onRedirectorError (): void {\r\n    this.reset()\r\n  }\r\n\r\n  init (): void {\r\n    this.instantiate()\r\n    setTimeout(() => {\r\n      this.autoConnect()\r\n    }, 4000)\r\n  }\r\n\r\n  autoConnect (): void {\r\n    if (this.redirector != null) {\r\n      this.redirector.start(WebSocket)\r\n      this.keyboardHelper.GrabKeyInput()\r\n    }\r\n  }\r\n\r\n  onEncodingChange (): void {\r\n    this.stopKvm()\r\n    timer(1000).subscribe(() => {\r\n      this.autoConnect()\r\n    })\r\n  }\r\n\r\n  reset = (): void => {\r\n    this.redirector = null\r\n    this.module = null\r\n    this.dataProcessor = null\r\n    this.height = 400\r\n    this.width = 400\r\n    this.instantiate()\r\n  }\r\n\r\n  stopKvm = (): void => {\r\n    this.redirector.stop()\r\n    this.keyboardHelper.UnGrabKeyInput()\r\n    this.reset()\r\n  }\r\n\r\n  onMouseup (event: MouseEvent): void {\r\n    if (this.mouseHelper != null) {\r\n      this.mouseHelper.mouseup(event)\r\n    }\r\n  }\r\n\r\n  onMousedown (event: MouseEvent): void {\r\n    if (this.mouseHelper != null) {\r\n      this.mouseHelper.mousedown(event)\r\n    }\r\n  }\r\n\r\n  onMousemove (event: MouseEvent): void {\r\n    if (this.mouseHelper != null) {\r\n      this.mouseHelper.mousemove(event)\r\n    }\r\n  }\r\n\r\n  ngOnDestroy (): void {\r\n    this.stopKvm()\r\n  }\r\n}\r\n","<div>\r\n  <canvas\r\n    class=\"canvas\"\r\n    #canvas\r\n    [width]=\"width\"\r\n    [height]=\"height\"\r\n    oncontextmenu=\"return false\"\r\n    (mouseup)=\"onMouseup($event)\"\r\n    (mousedown)=\"onMousedown($event)\"\r\n    (mousemove)=\"onMousemove($event)\"\r\n  ></canvas>\r\n</div>\r\n","import {\r\n  NgModule,\r\n  CUSTOM_ELEMENTS_SCHEMA,\r\n  ModuleWithProviders\r\n} from '@angular/core'\r\nimport { BrowserModule } from '@angular/platform-browser'\r\nimport { BrowserAnimationsModule } from '@angular/platform-browser/animations'\r\nimport { FlexLayoutModule } from '@angular/flex-layout'\r\nimport { KvmComponent } from './kvm.component'\r\nimport { HttpClientModule } from '@angular/common/http'\r\n@NgModule({\r\n  declarations: [KvmComponent],\r\n  imports: [\r\n    HttpClientModule,\r\n    FlexLayoutModule,\r\n    BrowserModule,\r\n    BrowserAnimationsModule\r\n  ],\r\n  exports: [KvmComponent],\r\n  schemas: [CUSTOM_ELEMENTS_SCHEMA]\r\n\r\n})\r\nexport class KvmModule {\r\n  public static forRoot (param: any): ModuleWithProviders<KvmModule> {\r\n    return {\r\n      ngModule: KvmModule,\r\n      providers: [\r\n        {\r\n          provide: 'userInput',\r\n          useValue: param\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}\r\n","/*\r\n * Public API Surface of kvm\r\n */\r\n\r\nexport * from './lib/kvm.component'\r\nexport * from './lib/kvm.module'\r\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './public-api';\n"],"names":["EventEmitter","ConsoleLogger","AMTKvmDataRedirector","Protocol","AMTDesktop","DataProcessor","MouseHelper","KeyBoardHelper","fromEvent","throttleTime","timer","i0.ɵɵelementStart","i0.ɵɵlistener","i0.ɵɵelementEnd","i0.ɵɵadvance","i0.ɵɵproperty","Component","Inject","ViewChild","Input","Output","HttpClientModule","FlexLayoutModule","BrowserModule","BrowserAnimationsModule","NgModule","CUSTOM_ELEMENTS_SCHEMA"],"mappings":"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"}