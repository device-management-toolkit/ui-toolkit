{"version":3,"sources":["../../../../src/angular/projects/kvm/src/lib/kvm.component.ts","../../../../src/angular/projects/kvm/src/lib/kvm.component.html","../../../../src/angular/projects/kvm/src/lib/kvm.module.ts"],"names":["KvmComponent","params","_this","this","width","height","deviceState","deviceStatus","EventEmitter","deviceConnection","selectedEncoding","powerState","deviceId","selected","server","mouseMove","encodings","value","viewValue","urlConstructor","mpsServer","replace","onConnectionStateChange","redirector","state","emit","reset","module","dataProcessor","instantiate","stopKvm","stop","keyboardHelper","UnGrabKeyInput","token","localStorage","getItem","window","location","pathname","split","includes","prototype","ngOnInit","logger","ConsoleLogger","subscribe","data","init","onEncodingChange","ngAfterViewInit","context","_a","canvas","nativeElement","getContext","AMTKvmDataRedirector","Protocol","KVM","FileReader","JSON","parse","AMTDesktop","DataProcessor","mouseHelper","MouseHelper","KeyBoardHelper","onProcessData","processData","bind","onStart","start","onNewState","onStateChange","onSendKvmData","onStateChanged","onError","onRedirectorError","onSend","send","bpp","fromEvent","_b","pipe","throttleTime","event","mousemove","setTimeout","autoConnect","WebSocket","GrabKeyInput","timer","checkPowerStatus","powerstate","onMouseup","mouseup","onMousedown","mousedown","onMousemove","ngOnDestroy","i0","ɵɵdirectiveInject","selectors","viewQuery","rf","ctx","i0.ɵɵelementStart","i0.ɵɵlistener","$event","i0.ɵɵelementEnd","i0.ɵɵadvance","i0.ɵɵproperty","Component","selector","templateUrl","styleUrls","Inject","ViewChild","static","Input","Output","KvmModule","forRoot","param","ngModule","providers","provide","useValue","HttpClientModule","FlexLayoutModule","BrowserModule","BrowserAnimationsModule","declarations","imports","exports","NgModule","schemas","CUSTOM_ELEMENTS_SCHEMA"],"mappings":"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","sourcesContent":["import {\r\n  AfterViewInit,\r\n  Component,\r\n  ElementRef,\r\n  EventEmitter,\r\n  Inject,\r\n  Input,\r\n  OnDestroy,\r\n  OnInit,\r\n  Output,\r\n  ViewChild\r\n} from '@angular/core'\r\nimport {\r\n  AMTDesktop,\r\n  AMTKvmDataRedirector,\r\n  ConsoleLogger,\r\n  DataProcessor,\r\n  IDataProcessor,\r\n  ILogger,\r\n  KeyBoardHelper,\r\n  MouseHelper,\r\n  Protocol\r\n} from '@open-amt-cloud-toolkit/ui-toolkit/core'\r\nimport { fromEvent, timer } from 'rxjs'\r\nimport { throttleTime } from 'rxjs/operators'\r\n\r\n@Component({\r\n  selector: 'amt-kvm',\r\n  templateUrl: './kvm.component.html',\r\n  styleUrls: ['./kvm.component.css']\r\n})\r\nexport class KvmComponent implements OnInit, AfterViewInit, OnDestroy {\r\n  @ViewChild('canvas', { static: false }) canvas: ElementRef | undefined\r\n  public context!: CanvasRenderingContext2D\r\n\r\n  // //setting a width and height for the canvas\r\n\r\n  @Input() public width = 400\r\n  @Input() public height = 400\r\n  @Output() deviceState: number = 0\r\n  @Output() deviceStatus: EventEmitter<number> = new EventEmitter<number>()\r\n  @Input() deviceConnection: EventEmitter<boolean> = new EventEmitter<boolean>()\r\n  @Input() selectedEncoding: EventEmitter<number> = new EventEmitter<number>()\r\n  token: any\r\n  module: any\r\n  redirector: any\r\n  dataProcessor!: IDataProcessor | null\r\n  mouseHelper!: MouseHelper\r\n  keyboardHelper!: KeyBoardHelper\r\n  logger!: ILogger\r\n  powerState: any = 0\r\n  deviceId: string = ''\r\n  selected: number = 1\r\n  timeInterval!: any\r\n  server: string = ''\r\n  mouseMove: any = null\r\n  mpsServer: boolean\r\n  encodings = [\r\n    { value: 1, viewValue: 'RLE 8' },\r\n    { value: 2, viewValue: 'RLE 16' }\r\n  ]\r\n\r\n  constructor (@Inject('userInput') public params) {\r\n    this.token = localStorage.getItem('loggedInUser')\r\n    this.deviceId = window.location.pathname.split('/')[2]\r\n    this.server = `${this.urlConstructor()}/relay`\r\n    this.mpsServer = this.params.mpsServer.includes('/mps')\r\n    if (this.mpsServer) {\r\n      // handles kong route\r\n      this.server = `${this.urlConstructor()}/ws/relay`\r\n    }\r\n  }\r\n\r\n  urlConstructor = (): string => {\r\n    return this.params.mpsServer.replace('http', 'ws')\r\n  }\r\n\r\n  ngOnInit (): void {\r\n    this.logger = new ConsoleLogger(1)\r\n    this.deviceConnection.subscribe((data: boolean) => {\r\n      if (data) {\r\n        this.init()\r\n      } else {\r\n        this.stopKvm()\r\n      }\r\n    })\r\n    this.selectedEncoding.subscribe((data) => {\r\n      this.selected = data\r\n      this.onEncodingChange()\r\n    })\r\n  }\r\n\r\n  ngAfterViewInit (): void {\r\n    this.init()\r\n  }\r\n\r\n  instantiate (): void {\r\n    this.context = this.canvas?.nativeElement.getContext('2d')\r\n    this.redirector = new AMTKvmDataRedirector(\r\n      this.logger,\r\n      Protocol.KVM,\r\n      new FileReader(),\r\n      this.deviceId,\r\n      16994,\r\n      '',\r\n      '',\r\n      0,\r\n      0,\r\n      JSON.parse(this.token).token,\r\n      this.server\r\n    )\r\n    this.module = new AMTDesktop(this.logger as any, this.context)\r\n    this.dataProcessor = new DataProcessor(\r\n      this.logger,\r\n      this.redirector,\r\n      this.module\r\n    )\r\n    this.mouseHelper = new MouseHelper(this.module, this.redirector, 200)\r\n    this.keyboardHelper = new KeyBoardHelper(this.module, this.redirector)\r\n\r\n    this.redirector.onProcessData = this.module.processData.bind(this.module)\r\n    this.redirector.onStart = this.module.start.bind(this.module)\r\n    this.redirector.onNewState = this.module.onStateChange.bind(this.module)\r\n    this.redirector.onSendKvmData = this.module.onSendKvmData.bind(this.module)\r\n    this.redirector.onStateChanged = this.onConnectionStateChange.bind(this)\r\n    this.redirector.onError = this.onRedirectorError.bind(this)\r\n    this.module.onSend = this.redirector.send.bind(this.redirector)\r\n    this.module.onProcessData = this.dataProcessor.processData.bind(\r\n      this.dataProcessor\r\n    )\r\n    this.module.bpp = this.selected\r\n    this.mouseMove = fromEvent(this.canvas?.nativeElement, 'mousemove')\r\n    this.mouseMove.pipe(throttleTime(200)).subscribe((event: any) => {\r\n      if (this.mouseHelper != null) {\r\n        this.mouseHelper.mousemove(event)\r\n      }\r\n    })\r\n  }\r\n\r\n  onConnectionStateChange = (redirector: any, state: number): any => {\r\n    this.deviceState = state\r\n    this.deviceStatus.emit(state)\r\n  }\r\n\r\n  onRedirectorError (): void {\r\n    this.reset()\r\n  }\r\n\r\n  init (): void {\r\n    this.instantiate()\r\n    setTimeout(() => {\r\n      this.autoConnect()\r\n    }, 4000)\r\n  }\r\n\r\n  autoConnect (): void {\r\n    if (this.redirector != null) {\r\n      this.redirector.start(WebSocket)\r\n      this.keyboardHelper.GrabKeyInput()\r\n    }\r\n  }\r\n\r\n  onEncodingChange (): void {\r\n    this.stopKvm()\r\n    timer(1000).subscribe(() => {\r\n      this.autoConnect()\r\n    })\r\n  }\r\n\r\n  checkPowerStatus (): boolean {\r\n    return this.powerState.powerstate === 2\r\n  }\r\n\r\n  reset = (): void => {\r\n    this.redirector = null\r\n    this.module = null\r\n    this.dataProcessor = null\r\n    this.height = 400\r\n    this.width = 400\r\n    this.instantiate()\r\n  }\r\n\r\n  stopKvm = (): void => {\r\n    this.redirector.stop()\r\n    this.keyboardHelper.UnGrabKeyInput()\r\n    this.reset()\r\n  }\r\n\r\n  onMouseup (event: MouseEvent): void {\r\n    if (this.mouseHelper != null) {\r\n      this.mouseHelper.mouseup(event)\r\n    }\r\n  }\r\n\r\n  onMousedown (event: MouseEvent): void {\r\n    if (this.mouseHelper != null) {\r\n      this.mouseHelper.mousedown(event)\r\n    }\r\n  }\r\n\r\n  onMousemove (event: MouseEvent): void {\r\n    if (this.mouseHelper != null) {\r\n      this.mouseHelper.mousemove(event)\r\n    }\r\n  }\r\n\r\n  ngOnDestroy (): void {\r\n    this.stopKvm()\r\n  }\r\n}\r\n","<div>\r\n  <canvas\r\n    class=\"canvas\"\r\n    #canvas\r\n    [width]=\"width\"\r\n    [height]=\"height\"\r\n    oncontextmenu=\"return false\"\r\n    (mouseup)=\"onMouseup($event)\"\r\n    (mousedown)=\"onMousedown($event)\"\r\n    (mousemove)=\"onMousemove($event)\"\r\n  ></canvas>\r\n</div>\r\n","import {\r\n  NgModule,\r\n  CUSTOM_ELEMENTS_SCHEMA,\r\n  ModuleWithProviders\r\n} from '@angular/core'\r\nimport { BrowserModule } from '@angular/platform-browser'\r\nimport { BrowserAnimationsModule } from '@angular/platform-browser/animations'\r\nimport { FlexLayoutModule } from '@angular/flex-layout'\r\nimport { KvmComponent } from './kvm.component'\r\nimport { HttpClientModule } from '@angular/common/http'\r\n@NgModule({\r\n  declarations: [KvmComponent],\r\n  imports: [\r\n    HttpClientModule,\r\n    FlexLayoutModule,\r\n    BrowserModule,\r\n    BrowserAnimationsModule\r\n  ],\r\n  exports: [KvmComponent],\r\n  schemas: [CUSTOM_ELEMENTS_SCHEMA]\r\n\r\n})\r\nexport class KvmModule {\r\n  public static forRoot (param: any): ModuleWithProviders<KvmModule> {\r\n    return {\r\n      ngModule: KvmModule,\r\n      providers: [\r\n        {\r\n          provide: 'userInput',\r\n          useValue: param\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}\r\n"]}