{"version":3,"file":"kvm.js","sources":["../../../../src/angular/projects/kvm/src/lib/kvm.component.ts","../../../../src/angular/projects/kvm/src/lib/kvm.component.html","../../../../src/angular/projects/kvm/src/lib/kvm.module.ts","../../../../src/angular/projects/kvm/src/public-api.ts","../../../../src/angular/projects/kvm/src/kvm.ts"],"sourcesContent":["import {\r\n  AfterViewInit,\r\n  Component,\r\n  ElementRef,\r\n  EventEmitter,\r\n  Inject,\r\n  Input,\r\n  OnDestroy,\r\n  OnInit,\r\n  Output,\r\n  ViewChild\r\n} from '@angular/core'\r\nimport {\r\n  AMTDesktop,\r\n  AMTKvmDataRedirector,\r\n  ConsoleLogger,\r\n  DataProcessor,\r\n  IDataProcessor,\r\n  ILogger,\r\n  KeyBoardHelper,\r\n  MouseHelper,\r\n  Protocol\r\n} from '@open-amt-cloud-toolkit/ui-toolkit/core'\r\nimport { fromEvent, timer } from 'rxjs'\r\nimport { throttleTime } from 'rxjs/operators'\r\n\r\n@Component({\r\n  selector: 'amt-kvm',\r\n  templateUrl: './kvm.component.html',\r\n  styleUrls: ['./kvm.component.css']\r\n})\r\nexport class KvmComponent implements OnInit, AfterViewInit, OnDestroy {\r\n  @ViewChild('canvas', { static: false }) canvas: ElementRef | undefined\r\n  public context!: CanvasRenderingContext2D\r\n\r\n  // //setting a width and height for the canvas\r\n\r\n  @Input() public width = 400\r\n  @Input() public height = 400\r\n  @Output() deviceState: number = 0\r\n  @Output() deviceStatus: EventEmitter<number> = new EventEmitter<number>()\r\n  @Input() deviceConnection: EventEmitter<boolean> = new EventEmitter<boolean>()\r\n  @Input() selectedEncoding: EventEmitter<number> = new EventEmitter<number>()\r\n  token: any\r\n  module: any\r\n  redirector: any\r\n  dataProcessor!: IDataProcessor | null\r\n  mouseHelper!: MouseHelper\r\n  keyboardHelper!: KeyBoardHelper\r\n  logger!: ILogger\r\n  powerState: any = 0\r\n  deviceId: string = ''\r\n  selected: number = 1\r\n  timeInterval!: any\r\n  server: string = ''\r\n  mouseMove: any = null\r\n  mpsServer: boolean\r\n  encodings = [\r\n    { value: 1, viewValue: 'RLE 8' },\r\n    { value: 2, viewValue: 'RLE 16' }\r\n  ]\r\n\r\n  constructor (@Inject('userInput') public params) {\r\n    this.token = localStorage.getItem('loggedInUser')\r\n    this.deviceId = window.location.pathname.split('/')[2]\r\n    this.server = `${this.urlConstructor()}/relay`\r\n    this.mpsServer = this.params.mpsServer.includes('/mps')\r\n    if (this.mpsServer) {\r\n      // handles kong route\r\n      this.server = `${this.urlConstructor()}/ws/relay`\r\n    }\r\n  }\r\n\r\n  urlConstructor = (): string => {\r\n    return this.params.mpsServer.replace('http', 'ws')\r\n  }\r\n\r\n  ngOnInit (): void {\r\n    this.logger = new ConsoleLogger(1)\r\n    this.deviceConnection.subscribe((data: boolean) => {\r\n      if (data) {\r\n        this.init()\r\n      } else {\r\n        this.stopKvm()\r\n      }\r\n    })\r\n    this.selectedEncoding.subscribe((data) => {\r\n      this.selected = data\r\n      this.onEncodingChange()\r\n    })\r\n  }\r\n\r\n  ngAfterViewInit (): void {\r\n    this.init()\r\n  }\r\n\r\n  instantiate (): void {\r\n    this.context = this.canvas?.nativeElement.getContext('2d')\r\n    this.redirector = new AMTKvmDataRedirector(\r\n      this.logger,\r\n      Protocol.KVM,\r\n      new FileReader(),\r\n      this.deviceId,\r\n      16994,\r\n      '',\r\n      '',\r\n      0,\r\n      0,\r\n      JSON.parse(this.token).token,\r\n      this.server\r\n    )\r\n    this.module = new AMTDesktop(this.logger as any, this.context)\r\n    this.dataProcessor = new DataProcessor(\r\n      this.logger,\r\n      this.redirector,\r\n      this.module\r\n    )\r\n    this.mouseHelper = new MouseHelper(this.module, this.redirector, 200)\r\n    this.keyboardHelper = new KeyBoardHelper(this.module, this.redirector)\r\n\r\n    this.redirector.onProcessData = this.module.processData.bind(this.module)\r\n    this.redirector.onStart = this.module.start.bind(this.module)\r\n    this.redirector.onNewState = this.module.onStateChange.bind(this.module)\r\n    this.redirector.onSendKvmData = this.module.onSendKvmData.bind(this.module)\r\n    this.redirector.onStateChanged = this.onConnectionStateChange.bind(this)\r\n    this.redirector.onError = this.onRedirectorError.bind(this)\r\n    this.module.onSend = this.redirector.send.bind(this.redirector)\r\n    this.module.onProcessData = this.dataProcessor.processData.bind(\r\n      this.dataProcessor\r\n    )\r\n    this.module.bpp = this.selected\r\n    this.mouseMove = fromEvent(this.canvas?.nativeElement, 'mousemove')\r\n    this.mouseMove.pipe(throttleTime(200)).subscribe((event: any) => {\r\n      if (this.mouseHelper != null) {\r\n        this.mouseHelper.mousemove(event)\r\n      }\r\n    })\r\n  }\r\n\r\n  onConnectionStateChange = (redirector: any, state: number): any => {\r\n    this.deviceState = state\r\n    this.deviceStatus.emit(state)\r\n  }\r\n\r\n  onRedirectorError (): void {\r\n    this.reset()\r\n  }\r\n\r\n  init (): void {\r\n    this.instantiate()\r\n    setTimeout(() => {\r\n      this.autoConnect()\r\n    }, 4000)\r\n  }\r\n\r\n  autoConnect (): void {\r\n    if (this.redirector != null) {\r\n      this.redirector.start(WebSocket)\r\n      this.keyboardHelper.GrabKeyInput()\r\n    }\r\n  }\r\n\r\n  onEncodingChange (): void {\r\n    this.stopKvm()\r\n    timer(1000).subscribe(() => {\r\n      this.autoConnect()\r\n    })\r\n  }\r\n\r\n  checkPowerStatus (): boolean {\r\n    return this.powerState.powerstate === 2\r\n  }\r\n\r\n  reset = (): void => {\r\n    this.redirector = null\r\n    this.module = null\r\n    this.dataProcessor = null\r\n    this.height = 400\r\n    this.width = 400\r\n    this.instantiate()\r\n  }\r\n\r\n  stopKvm = (): void => {\r\n    this.redirector.stop()\r\n    this.keyboardHelper.UnGrabKeyInput()\r\n    this.reset()\r\n  }\r\n\r\n  onMouseup (event: MouseEvent): void {\r\n    if (this.mouseHelper != null) {\r\n      this.mouseHelper.mouseup(event)\r\n    }\r\n  }\r\n\r\n  onMousedown (event: MouseEvent): void {\r\n    if (this.mouseHelper != null) {\r\n      this.mouseHelper.mousedown(event)\r\n    }\r\n  }\r\n\r\n  onMousemove (event: MouseEvent): void {\r\n    if (this.mouseHelper != null) {\r\n      this.mouseHelper.mousemove(event)\r\n    }\r\n  }\r\n\r\n  ngOnDestroy (): void {\r\n    this.stopKvm()\r\n  }\r\n}\r\n","<div>\r\n  <canvas\r\n    class=\"canvas\"\r\n    #canvas\r\n    [width]=\"width\"\r\n    [height]=\"height\"\r\n    oncontextmenu=\"return false\"\r\n    (mouseup)=\"onMouseup($event)\"\r\n    (mousedown)=\"onMousedown($event)\"\r\n    (mousemove)=\"onMousemove($event)\"\r\n  ></canvas>\r\n</div>\r\n","import {\r\n  NgModule,\r\n  CUSTOM_ELEMENTS_SCHEMA,\r\n  ModuleWithProviders\r\n} from '@angular/core'\r\nimport { BrowserModule } from '@angular/platform-browser'\r\nimport { BrowserAnimationsModule } from '@angular/platform-browser/animations'\r\nimport { FlexLayoutModule } from '@angular/flex-layout'\r\nimport { KvmComponent } from './kvm.component'\r\nimport { HttpClientModule } from '@angular/common/http'\r\n@NgModule({\r\n  declarations: [KvmComponent],\r\n  imports: [\r\n    HttpClientModule,\r\n    FlexLayoutModule,\r\n    BrowserModule,\r\n    BrowserAnimationsModule\r\n  ],\r\n  exports: [KvmComponent],\r\n  schemas: [CUSTOM_ELEMENTS_SCHEMA]\r\n\r\n})\r\nexport class KvmModule {\r\n  public static forRoot (param: any): ModuleWithProviders<KvmModule> {\r\n    return {\r\n      ngModule: KvmModule,\r\n      providers: [\r\n        {\r\n          provide: 'userInput',\r\n          useValue: param\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}\r\n","/*\r\n * Public API Surface of kvm\r\n */\r\n\r\nexport * from './lib/kvm.component'\r\nexport * from './lib/kvm.module'\r\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './public-api';\n"],"names":["i0.ɵɵelementStart","i0.ɵɵlistener","i0.ɵɵelementEnd","i0.ɵɵadvance","i0.ɵɵproperty"],"mappings":"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"}