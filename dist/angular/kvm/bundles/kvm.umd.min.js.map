{"version":3,"sources":["../../../../src/angular/projects/kvm/src/lib/kvm.component.ts","../../../../src/angular/projects/kvm/src/lib/kvm.component.html","../../../../src/angular/projects/kvm/src/lib/kvm.module.ts"],"names":["KvmComponent","params","activatedRoute","_this","this","width","height","deviceStatus","EventEmitter","deviceConnection","selectedEncoding","powerState","deviceId","selected","server","mouseMove","encodings","value","viewValue","urlConstructor","mpsServer","replace","onConnectionStateChange","redirector","state","emit","reset","module","dataProcessor","instantiate","stopKvm","stop","keyboardHelper","UnGrabKeyInput","token","localStorage","getItem","includes","prototype","ngOnInit","subscribe","id","logger","ConsoleLogger","data","init","onEncodingChange","ngAfterViewInit","context","_a","canvas","nativeElement","getContext","AMTKvmDataRedirector","Protocol","KVM","FileReader","JSON","parse","AMTDesktop","DataProcessor","mouseHelper","MouseHelper","KeyBoardHelper","onProcessData","processData","bind","onStart","start","onNewState","onStateChange","onSendKvmData","onStateChanged","onError","onRedirectorError","onSend","send","bpp","fromEvent","_b","pipe","throttleTime","event","mousemove","setTimeout","autoConnect","WebSocket","GrabKeyInput","timer","onMouseup","mouseup","onMousedown","mousedown","onMousemove","ngOnDestroy","i0","ɵɵdirectiveInject","i1","ActivatedRoute","selectors","viewQuery","rf","ctx","i0.ɵɵelementStart","i0.ɵɵlistener","$event","i0.ɵɵelementEnd","i0.ɵɵadvance","i0.ɵɵproperty","Component","selector","templateUrl","styleUrls","Inject","ViewChild","static","device","Input","Output","KvmModule","forRoot","param","ngModule","providers","provide","useValue","HttpClientModule","FlexLayoutModule","BrowserModule","BrowserAnimationsModule","declarations","imports","exports","NgModule","schemas","CUSTOM_ELEMENTS_SCHEMA"],"mappings":"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","sourcesContent":["import {\r\n  AfterViewInit,\r\n  Component,\r\n  ElementRef,\r\n  EventEmitter,\r\n  Inject,\r\n  Input,\r\n  OnDestroy,\r\n  OnInit,\r\n  Output,\r\n  ViewChild\r\n} from '@angular/core'\r\nimport {\r\n  AMTDesktop,\r\n  AMTKvmDataRedirector,\r\n  ConsoleLogger,\r\n  DataProcessor,\r\n  IDataProcessor,\r\n  ILogger,\r\n  KeyBoardHelper,\r\n  MouseHelper,\r\n  Protocol\r\n} from '@open-amt-cloud-toolkit/ui-toolkit/core'\r\nimport { fromEvent, timer } from 'rxjs'\r\nimport { throttleTime } from 'rxjs/operators'\r\nimport { ActivatedRoute } from '@angular/router'\r\n\r\n@Component({\r\n  selector: 'amt-kvm',\r\n  templateUrl: './kvm.component.html',\r\n  styleUrls: ['./kvm.component.css']\r\n})\r\nexport class KvmComponent implements OnInit, AfterViewInit, OnDestroy {\r\n  @ViewChild('canvas', { static: false }) canvas: ElementRef | undefined\r\n  @ViewChild('device', { static: false }) device: string\r\n  public context!: CanvasRenderingContext2D\r\n\r\n  // //setting a width and height for the canvas\r\n\r\n  @Input() public width = 400\r\n  @Input() public height = 400\r\n  @Output() deviceStatus: EventEmitter<number> = new EventEmitter<number>()\r\n  @Input() deviceConnection: EventEmitter<boolean> = new EventEmitter<boolean>()\r\n  @Input() selectedEncoding: EventEmitter<number> = new EventEmitter<number>()\r\n  token: any\r\n  module: any\r\n  redirector: any\r\n  dataProcessor!: IDataProcessor | null\r\n  mouseHelper!: MouseHelper\r\n  keyboardHelper!: KeyBoardHelper\r\n  logger!: ILogger\r\n  powerState: any = 0\r\n  deviceId: string = ''\r\n  selected: number = 1\r\n  timeInterval!: any\r\n  server: string = ''\r\n  mouseMove: any = null\r\n  mpsServer: boolean\r\n  encodings = [\r\n    { value: 1, viewValue: 'RLE 8' },\r\n    { value: 2, viewValue: 'RLE 16' }\r\n  ]\r\n\r\n  constructor (@Inject('userInput') public params, public activatedRoute: ActivatedRoute) {\r\n    this.token = localStorage.getItem('loggedInUser')\r\n    this.server = `${this.urlConstructor()}/relay`\r\n    this.mpsServer = this.params.mpsServer.includes('/mps')\r\n    if (this.mpsServer) {\r\n      // handles kong route\r\n      this.server = `${this.urlConstructor()}/ws/relay`\r\n    }\r\n  }\r\n\r\n  urlConstructor = (): string => {\r\n    return this.params.mpsServer.replace('http', 'ws')\r\n  }\r\n\r\n  ngOnInit (): void {\r\n    this.activatedRoute.params.subscribe(params => {\r\n      this.deviceId = params.id\r\n    })\r\n    this.logger = new ConsoleLogger(1)\r\n    this.deviceConnection.subscribe((data: boolean) => {\r\n      if (data) {\r\n        this.init()\r\n      } else {\r\n        this.stopKvm()\r\n      }\r\n    })\r\n    this.selectedEncoding.subscribe((data) => {\r\n      this.selected = data\r\n      this.onEncodingChange()\r\n    })\r\n  }\r\n\r\n  ngAfterViewInit (): void {\r\n    this.init()\r\n  }\r\n\r\n  instantiate (): void {\r\n    this.context = this.canvas?.nativeElement.getContext('2d')\r\n    this.redirector = new AMTKvmDataRedirector(\r\n      this.logger,\r\n      Protocol.KVM,\r\n      new FileReader(),\r\n      this.deviceId,\r\n      16994,\r\n      '',\r\n      '',\r\n      0,\r\n      0,\r\n      JSON.parse(this.token).token,\r\n      this.server\r\n    )\r\n    this.module = new AMTDesktop(this.logger as any, this.context)\r\n    this.dataProcessor = new DataProcessor(\r\n      this.logger,\r\n      this.redirector,\r\n      this.module\r\n    )\r\n    this.mouseHelper = new MouseHelper(this.module, this.redirector, 200)\r\n    this.keyboardHelper = new KeyBoardHelper(this.module, this.redirector)\r\n    this.redirector.onProcessData = this.module.processData.bind(this.module)\r\n    this.redirector.onStart = this.module.start.bind(this.module)\r\n    this.redirector.onNewState = this.module.onStateChange.bind(this.module)\r\n    this.redirector.onSendKvmData = this.module.onSendKvmData.bind(this.module)\r\n    this.redirector.onStateChanged = this.onConnectionStateChange.bind(this)\r\n    this.redirector.onError = this.onRedirectorError.bind(this)\r\n    this.module.onSend = this.redirector.send.bind(this.redirector)\r\n    this.module.onProcessData = this.dataProcessor.processData.bind(\r\n      this.dataProcessor\r\n    )\r\n    this.module.bpp = this.selected\r\n    this.mouseMove = fromEvent(this.canvas?.nativeElement, 'mousemove')\r\n    this.mouseMove.pipe(throttleTime(200)).subscribe((event: any) => {\r\n      if (this.mouseHelper != null) {\r\n        this.mouseHelper.mousemove(event)\r\n      }\r\n    })\r\n  }\r\n\r\n  onConnectionStateChange = (redirector: any, state: number): any => {\r\n    this.deviceStatus.emit(state)\r\n  }\r\n\r\n  onRedirectorError (): void {\r\n    this.reset()\r\n  }\r\n\r\n  init (): void {\r\n    this.instantiate()\r\n    setTimeout(() => {\r\n      this.autoConnect()\r\n    }, 4000)\r\n  }\r\n\r\n  autoConnect (): void {\r\n    if (this.redirector != null) {\r\n      this.redirector.start(WebSocket)\r\n      this.keyboardHelper.GrabKeyInput()\r\n    }\r\n  }\r\n\r\n  onEncodingChange (): void {\r\n    this.stopKvm()\r\n    timer(1000).subscribe(() => {\r\n      this.autoConnect()\r\n    })\r\n  }\r\n\r\n  reset = (): void => {\r\n    this.redirector = null\r\n    this.module = null\r\n    this.dataProcessor = null\r\n    this.height = 400\r\n    this.width = 400\r\n    this.instantiate()\r\n  }\r\n\r\n  stopKvm = (): void => {\r\n    this.redirector.stop()\r\n    this.keyboardHelper.UnGrabKeyInput()\r\n    this.reset()\r\n  }\r\n\r\n  onMouseup (event: MouseEvent): void {\r\n    if (this.mouseHelper != null) {\r\n      this.mouseHelper.mouseup(event)\r\n    }\r\n  }\r\n\r\n  onMousedown (event: MouseEvent): void {\r\n    if (this.mouseHelper != null) {\r\n      this.mouseHelper.mousedown(event)\r\n    }\r\n  }\r\n\r\n  onMousemove (event: MouseEvent): void {\r\n    if (this.mouseHelper != null) {\r\n      this.mouseHelper.mousemove(event)\r\n    }\r\n  }\r\n\r\n  ngOnDestroy (): void {\r\n    this.stopKvm()\r\n  }\r\n}\r\n","<div>\r\n  <canvas\r\n    class=\"canvas\"\r\n    #canvas\r\n    [width]=\"width\"\r\n    [height]=\"height\"\r\n    oncontextmenu=\"return false\"\r\n    (mouseup)=\"onMouseup($event)\"\r\n    (mousedown)=\"onMousedown($event)\"\r\n    (mousemove)=\"onMousemove($event)\"\r\n  ></canvas>\r\n</div>\r\n","import {\r\n  NgModule,\r\n  CUSTOM_ELEMENTS_SCHEMA,\r\n  ModuleWithProviders\r\n} from '@angular/core'\r\nimport { BrowserModule } from '@angular/platform-browser'\r\nimport { BrowserAnimationsModule } from '@angular/platform-browser/animations'\r\nimport { FlexLayoutModule } from '@angular/flex-layout'\r\nimport { KvmComponent } from './kvm.component'\r\nimport { HttpClientModule } from '@angular/common/http'\r\n@NgModule({\r\n  declarations: [KvmComponent],\r\n  imports: [\r\n    HttpClientModule,\r\n    FlexLayoutModule,\r\n    BrowserModule,\r\n    BrowserAnimationsModule\r\n  ],\r\n  exports: [KvmComponent],\r\n  schemas: [CUSTOM_ELEMENTS_SCHEMA]\r\n\r\n})\r\nexport class KvmModule {\r\n  public static forRoot (param: any): ModuleWithProviders<KvmModule> {\r\n    return {\r\n      ngModule: KvmModule,\r\n      providers: [\r\n        {\r\n          provide: 'userInput',\r\n          useValue: param\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}\r\n"]}